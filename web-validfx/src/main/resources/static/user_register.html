<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>用户注册</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" type="text/css" href="/css/easyui.css">
    <link rel="stylesheet" type="text/css" href="/css/icon.css">
    <style type="text/css">
        .ff label{
            display:block;
            width:100px;
        }
    </style>
    <script type="text/javascript" src="/js/jquery-1.6.1.min.js"></script>

    <script type="text/javascript" src="/js/HttpClient.js"></script>

    <script type="text/javascript">
        var api = new HttpClient();
        function register() {
            var form = $(event.target).parents("form");
            console.log(form);
            console.log(form.form('validate'),"validate result");
            if(form.form('validate') || true) {
//                var userId = form.find("input[name='userId']").val();
//                var email = form.find("input[name='email']").val();

                var data = {};
                var inputs = form.find("[name]");
                inputs.each(function(index,element){
                    var name = $(element).attr("name");
                    var val = $(element).val();
                    var inputType = $(element).attr("type");
                    if(inputType === "checkbox"){
                        if($(element).is(':checked')){
                            if(data[name] == null)
                                data[name] = [];
                            data[name].push(val);
                        }
                    }else if(inputType === "radio"){
                        if($(element).is(':checked')) {
                            data[name] = val;
                        }
                    }else{
                        data[name] = val;
                    }

                    //console.log(element,index);
                });
                api.post({
                    url: "/users/register", data: data, success: function (resp) {
                        console.log(resp);
                    }
                });
            }
        }
    </script>
</head>
<body>
<div style="width:230px;background:#fafafa;padding:10px;">
    <div style="padding:3px 2px;border-bottom:1px solid #ccc">用户注册</div>
    <form id="ff" method="post" class="ff">
        <div>
            <label for="field_userId">用户名:</label>
            <input id="field_userId" class="easyui-validatebox" type="text" name="userId"></input>
        </div>
        <div>
            <label for="field_email">Email:</label>
            <input id="field_email" class="easyui-validatebox" type="text" name="email"></input>
        </div>
        <div>
            <label for="field_mobile">手机:</label>
            <input id="field_mobile" class="easyui-validatebox" type="text" name="phone"></input>
        </div>
        <div>
            <label for="field_hobbies1">爱好（多选）:</label>
            <input id="field_hobbies1" class="easyui-validatebox" type="checkbox" value="运动" name="hobbies"/>运动</input>
            <input id="field_hobbies2" class="easyui-validatebox" type="checkbox" value="音乐" name="hobbies"/>音乐</input>
            <input id="field_hobbies3" class="easyui-validatebox" type="checkbox" value="绘画" name="hobbies"/>绘画</input>
            <input id="field_hobbies4" class="easyui-validatebox" type="checkbox" value="舞蹈" name="hobbies"/>舞蹈</input>
        </div>
        <div>
            <label for="field_gender1">性别（单选）:</label>
            <input id="field_gender1" class="easyui-validatebox" type="radio" value="男" name="gender"/>男</input>
            <input id="field_gender2" class="easyui-validatebox" type="radio" value="女" name="gender"/>女</input>
            <input id="field_gender3" class="easyui-validatebox" type="radio" value="保密" name="gender"/>保密</input>
        </div>

        <div>
            <input type="button" onclick="javascript:register();" value="保存">
        </div>
    </form>

</div>
<div style="width:230px;background:#fafafa;padding:10px;">
    <form id="ff2" method="post"  class="ff">
        <div>
            <label for="field_userId2">用户名:</label>
            <input id="field_userId2" class="easyui-validatebox" type="text" name="userId"></input>
        </div>
        <div>
            <label for="field_email2">Email:</label>
            <input id="field_email2" class="easyui-validatebox" type="text" name="email"></input>
        </div>
        <div>
            <label for="field_mobile2">手机:</label>
            <input id="field_mobile2" class="easyui-validatebox" type="text" name="phone"></input>
        </div>

        <div>
            <input type="button" onclick="javascript:register();" value="保存">
        </div>
    </form>
</div>
<!-- -->
<script type="text/javascript">
    var getValidType = function (rules) {
        var retRules = "";
        for(var i in rules){
            var rule = rules[i];
            var ruleInfo = rule.name;
            if(rule.parameters){
                var ps = "";
                for(var p in rule.parameters){
                    //if("message" == p)
                    //    continue;
                    var val = rule.parameters[p];
                    if(typeof val === "number"){
                        ps += val+",";
                    }else if(typeof val === "string"){
                        ps += "\"" + val +"\",";
                    }else{
                        ps += "\"" + val +"\",";
                    }
                }
                if(ps.length > 1){
                    retRules += "'" + ruleInfo + "[" + ps.substr(0,ps.length-1) + "]',"
                    continue;
                }
            }
            retRules += "'" + ruleInfo + "',";
        }
        if(rules.length > 1)
            return "[" + retRules.substr(0,retRules.length-1) + "]";

        return retRules.substr(0,retRules.length-1);
    };
    var bindVoModel = function (json) {
        console.log(json,"bindVoModel");

        for(var i in json){
            var f = json[i];
            var form = $("#"+f.form);
            if(form[0]){
                for(var j in f.items){
                    var item = f.items[j];
                    var input = form.find("input[name='" + item.propertyName + "']");
                    if(input[0]){
                        var data_options = "";
                        if(item.required)
                            data_options = "required:" + item.required + ",";
                            //input.attr("required",item.required);
                        if(item.rules && item.rules.length > 0) {
                            var validType = getValidType(item.rules);
                            //input.attr("validType", validType);
                            data_options += "validType:" + validType;
                        }
                        input.attr("data-options",data_options);
                    }
                }
            }
        }

//        $(function(){
//
//            // 通过json动态绑定校验
//            //*
//            // get(url) url = /vo_model.js  js扩展名的用意就是nginx可以做缓存
//            var json_validation ={"email": {"required":"true","validType":"email"},"userId":{"required":"true"}};
//
//            for(var field in json_validation){
//                var field_valid_data = json_validation[field];
//                // console.log(field,field_valid_data);
//                var input = $('#field_'+field)
//                for(var attr in field_valid_data){
//                    input.attr(attr,field_valid_data[attr]);
//                }
//            }
//            // */
//        });
    };
</script>
<script type="text/javascript" src="/validators/models/ff:user,ff2:user?callback=bindVoModel"></script>

<script type="text/javascript" src="/js/jquery.easyui.min.js"></script>

<!-- 自定义校验规则 -->
<script type="text/javascript" src="/js/validate-rules.js?5"></script>
<script type="text/javascript" src="/validators/rules?callback=extendValidateRules"></script>
</body>
</html>